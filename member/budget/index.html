<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>会派予算管理 | 創政MISATO</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --navy: #2c4a6e;
            --navy-light: #3d5a80;
            --green: #7cb342;
            --green-light: #a5d66a;
            --green-dark: #5a8f2a;
            --teal: #0d9488;
            --orange: #f59e0b;
            --orange-light: #fbbf24;
            --purple: #8b5cf6;
            --bg: #fafbfc;
            --bg-warm: #f8f9fa;
            --white: #ffffff;
            --gray: #6b7280;
            --gray-light: #e5e7eb;
            --gray-lighter: #f3f4f6;
            --text: #374151;
            --text-light: #6b7280;
            --danger: #dc2626;
            --danger-light: #fef2f2;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.8;
            min-height: 100vh;
        }

        /* ===== Login ===== */
        #loginScreen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #2c4a6e 0%, #3d5a80 50%, #5a8f2a 100%);
        }
        .login-card {
            background: var(--white);
            border-radius: 16px;
            padding: 3rem 2.5rem;
            width: 100%;
            max-width: 420px;
            margin: 1rem;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            text-align: center;
        }
        .login-logo {
            font-size: 1.8rem;
            font-weight: 900;
            color: var(--navy);
            margin-bottom: 0.3rem;
        }
        .login-sub {
            color: var(--gray);
            font-size: 0.85rem;
            margin-bottom: 2rem;
        }
        .login-input {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--gray-lighter);
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            margin-bottom: 1rem;
            transition: border-color 0.2s;
        }
        .login-input:focus { border-color: var(--green); }
        .login-btn {
            width: 100%;
            padding: 0.85rem;
            background: var(--green);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: background 0.2s;
        }
        .login-btn:hover { background: var(--green-dark); }
        .login-error {
            background: #fef2f2;
            color: #dc2626;
            padding: 0.6rem;
            border-radius: 8px;
            font-size: 0.82rem;
            margin-bottom: 1rem;
            display: none;
            border: 1px solid #fecaca;
        }

        /* ===== Header ===== */
        #mainContent { display: none; }

        .header {
            background: var(--white);
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-inner {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: var(--text);
        }
        .header-logo-icon { width: 40px; height: 40px; }
        .header-logo-icon img { width: 100%; height: 100%; object-fit: contain; }
        .header-logo-text {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text);
        }
        .header-nav {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .header-nav a {
            text-decoration: none;
            color: var(--gray);
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            transition: all 0.2s;
        }
        .header-nav a:hover {
            background: var(--gray-lighter);
            color: var(--text);
        }
        .header-nav a.active {
            background: var(--navy);
            color: var(--white);
        }

        /* ===== Main Content ===== */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 100px 2rem 3rem;
        }

        .page-title {
            text-align: center;
            margin-bottom: 2rem;
        }
        .page-title h1 {
            font-size: 2rem;
            font-weight: 900;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }
        .page-title p {
            color: var(--gray);
            font-size: 0.95rem;
        }

        /* ===== Account Switcher ===== */
        .account-switcher {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .account-btn {
            padding: 0.75rem 2rem;
            border: 2px solid var(--gray-light);
            background: var(--white);
            color: var(--gray);
            font-size: 1rem;
            font-weight: 700;
            font-family: inherit;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .account-btn:hover {
            border-color: var(--navy);
            color: var(--navy);
        }
        .account-btn.active.seimu {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            border-color: var(--navy);
            color: var(--white);
        }
        .account-btn.active.tsumitate {
            background: linear-gradient(135deg, var(--orange) 0%, var(--orange-light) 100%);
            border-color: var(--orange);
            color: var(--white);
        }
        .account-btn.active.personal {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: #6366f1;
            color: var(--white);
        }
        .account-btn svg {
            width: 20px;
            height: 20px;
        }

        /* ===== Tab Navigation ===== */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: var(--white);
            color: var(--gray);
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .tab-btn:hover {
            background: var(--gray-lighter);
        }
        .tab-btn.active {
            background: var(--navy);
            color: var(--white);
        }
        .tab-btn svg {
            width: 20px;
            height: 20px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* ===== Dashboard Stats ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .stat-card.total {
            background: linear-gradient(135deg, var(--navy) 0%, var(--navy-light) 100%);
            color: var(--white);
        }
        .stat-card.total.tsumitate {
            background: linear-gradient(135deg, var(--orange) 0%, var(--orange-light) 100%);
        }
        .stat-card.used {
            background: linear-gradient(135deg, var(--teal) 0%, #14b8a6 100%);
            color: var(--white);
        }
        .stat-card.remaining {
            background: linear-gradient(135deg, var(--green) 0%, var(--green-light) 100%);
            color: var(--white);
        }
        .stat-card.deposit {
            background: linear-gradient(135deg, var(--purple) 0%, #a78bfa 100%);
            color: var(--white);
        }
        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.6rem;
            font-weight: 900;
            margin-bottom: 0.25rem;
        }
        .stat-sub {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        /* ===== Progress Bar ===== */
        .progress-section {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .progress-title {
            font-weight: 700;
            color: var(--navy);
        }
        .progress-percent {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--teal);
        }
        .progress-bar {
            height: 20px;
            background: var(--gray-lighter);
            border-radius: 10px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--teal), var(--green));
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        .progress-fill.warning {
            background: linear-gradient(90deg, var(--orange), #f97316);
        }
        .progress-fill.danger {
            background: linear-gradient(90deg, var(--danger), #ef4444);
        }

        /* ===== Charts ===== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .chart-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .chart-title {
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 1rem;
        }
        .chart-container {
            position: relative;
            height: 280px;
        }

        /* ===== Form ===== */
        .form-card {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            max-width: 700px;
            margin: 0 auto;
        }
        .form-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 1.5rem;
            text-align: center;
        }
        .form-group {
            margin-bottom: 1.25rem;
        }
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.85rem 1rem;
            background: var(--gray-lighter);
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            color: var(--text);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--green);
        }
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        .form-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1.5rem;
        }
        .btn {
            padding: 0.85rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary {
            background: var(--green);
            color: var(--white);
        }
        .btn-primary:hover {
            background: var(--green-dark);
        }
        .btn-secondary {
            background: var(--gray-light);
            color: var(--text);
        }
        .btn-secondary:hover {
            background: var(--gray);
            color: var(--white);
        }
        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }
        .btn-danger:hover {
            background: #b91c1c;
        }
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* ===== Receipt Upload ===== */
        .receipt-upload-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px dashed #0ea5e9;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        .receipt-upload-section:hover {
            border-color: var(--navy);
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
        }
        .receipt-upload-section.dragover {
            border-color: var(--green);
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }
        .receipt-upload-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            background: var(--white);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .receipt-upload-icon svg {
            width: 30px;
            height: 30px;
            stroke: #0ea5e9;
        }
        .receipt-upload-text {
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }
        .receipt-upload-sub {
            font-size: 0.85rem;
            color: var(--gray);
        }
        .receipt-upload-input {
            display: none;
        }
        .receipt-preview {
            display: none;
            margin-top: 1rem;
        }
        .receipt-preview.show {
            display: block;
        }
        .receipt-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .ai-analyzing {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .ai-analyzing.show {
            display: block;
        }
        .ai-analyzing-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--gray-light);
            border-top-color: var(--navy);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ===== Account Type Toggle ===== */
        .account-toggle {
            display: flex;
            background: var(--gray-lighter);
            border-radius: 8px;
            padding: 4px;
        }
        .account-toggle-btn {
            flex: 1;
            padding: 0.6rem 1rem;
            border: none;
            background: transparent;
            color: var(--gray);
            font-size: 0.9rem;
            font-weight: 600;
            font-family: inherit;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .account-toggle-btn.active {
            background: var(--white);
            color: var(--navy);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .account-toggle-btn.active.seimu {
            color: var(--navy);
        }
        .account-toggle-btn.active.tsumitate {
            color: var(--orange);
        }

        /* ===== Table ===== */
        .table-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .table-title {
            font-weight: 700;
            color: var(--navy);
        }
        .table-filters {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .filter-select {
            padding: 0.5rem 1rem;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--white);
            color: var(--text);
        }
        .table-wrapper {
            overflow-x: auto;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th, .data-table td {
            padding: 0.85rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-light);
        }
        .data-table th {
            background: var(--gray-lighter);
            font-weight: 600;
            color: var(--text);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .data-table td {
            font-size: 0.95rem;
        }
        .data-table .amount {
            text-align: right;
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }
        .data-table .actions {
            white-space: nowrap;
        }
        .data-table .receipt-cell {
            text-align: center;
        }
        .data-table .receipt-thumb {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--gray-light);
            cursor: pointer;
            transition: transform 0.2s;
        }
        .data-table .receipt-thumb:hover {
            transform: scale(1.5);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .data-table .actions button {
            padding: 0.4rem 0.6rem;
            margin-right: 0.25rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: var(--gray-lighter);
            color: var(--gray);
            transition: all 0.2s;
        }
        .data-table .actions button:hover {
            background: var(--navy);
            color: var(--white);
        }
        .data-table .actions button.delete:hover {
            background: var(--danger);
        }
        .table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid var(--gray-light);
        }
        .table-total {
            font-weight: 700;
            font-size: 1.1rem;
        }
        .table-total span {
            color: var(--teal);
            font-family: 'Courier New', monospace;
        }
        .no-data {
            text-align: center;
            color: var(--gray);
            padding: 3rem;
        }
        .category-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            background: var(--gray-lighter);
            color: var(--text);
        }
        .category-badge.research { background: #dbeafe; color: #1d4ed8; }
        .category-badge.training { background: #dcfce7; color: #16a34a; }
        .category-badge.pr { background: #fef3c7; color: #d97706; }
        .category-badge.materials { background: #f3e8ff; color: #9333ea; }
        .category-badge.other { background: #e5e7eb; color: #4b5563; }

        .account-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .account-badge.seimu {
            background: #dbeafe;
            color: var(--navy);
        }
        .account-badge.tsumitate {
            background: #fef3c7;
            color: #b45309;
        }

        /* ===== Settings ===== */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        .settings-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }
        .settings-title {
            font-weight: 700;
            color: var(--navy);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .settings-title svg {
            width: 20px;
            height: 20px;
        }
        .budget-input-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .budget-input-row label {
            flex: 1;
            font-size: 0.9rem;
        }
        .budget-input-row input {
            width: 140px;
            padding: 0.5rem;
            border: 1px solid var(--gray-light);
            border-radius: 6px;
            font-family: inherit;
            text-align: right;
        }
        .export-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* ===== Modal ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: var(--white);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            margin: 1rem;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--navy);
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--gray);
            cursor: pointer;
        }

        /* ===== Toast ===== */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: var(--navy);
            color: var(--white);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 300;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success {
            background: var(--green);
        }
        .toast.error {
            background: var(--danger);
        }

        /* ===== Deposit Section ===== */
        .deposit-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .deposit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .deposit-title {
            font-weight: 700;
            color: #92400e;
        }
        .deposit-form {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .deposit-form input {
            padding: 0.6rem 1rem;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            font-family: inherit;
            background: var(--white);
        }
        .deposit-form select {
            padding: 0.6rem 1rem;
            border: 1px solid #fcd34d;
            border-radius: 6px;
            font-family: inherit;
            background: var(--white);
        }

        /* ===== Personal Budget ===== */
        .personal-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .personal-header .section-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: #6366f1;
            margin: 0 0 1rem 0;
        }
        .member-tabs {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .member-tab {
            padding: 0.6rem 1.2rem;
            border: 2px solid #e5e7eb;
            background: var(--white);
            color: var(--gray);
            font-size: 0.95rem;
            font-weight: 600;
            font-family: inherit;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .member-tab:hover {
            border-color: #6366f1;
            color: #6366f1;
        }
        .member-tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border-color: #6366f1;
            color: var(--white);
        }
        .member-select {
            display: none;
        }

        /* ===== Footer ===== */
        .footer {
            background: #1f2937;
            padding: 3rem 2rem 1.5rem;
            margin-top: 3rem;
        }
        .footer-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 2rem;
        }
        .footer-brand {}
        .footer-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }
        .footer-logo img {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        .footer-logo-text {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--white);
        }
        .footer-tagline {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.7;
        }
        .footer-nav-group {}
        .footer-nav-title {
            font-weight: 700;
            color: var(--white);
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }
        .footer-nav-group a {
            display: block;
            color: #9ca3af;
            text-decoration: none;
            font-size: 0.85rem;
            padding: 0.3rem 0;
            transition: color 0.2s;
        }
        .footer-nav-group a:hover {
            color: var(--white);
        }
        .footer-copy {
            text-align: center;
            color: #6b7280;
            font-size: 0.8rem;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid #374151;
        }

        /* ===== Responsive ===== */
        @media (max-width: 768px) {
            .header {
                padding: 0.75rem 1rem;
            }
            .header-logo-text {
                display: none;
            }
            .header-nav {
                gap: 0.5rem;
            }
            .header-nav a {
                padding: 0.4rem 0.7rem;
                font-size: 0.8rem;
            }
            .main-container {
                padding: 90px 1rem 2rem;
            }
            .page-title h1 {
                font-size: 1.5rem;
            }
            .account-switcher {
                flex-direction: column;
                align-items: center;
            }
            .account-btn {
                width: 100%;
                max-width: 250px;
                justify-content: center;
            }
            .tab-btn {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .stat-value {
                font-size: 1.3rem;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 250px;
            }
            .form-row, .form-row-3 {
                grid-template-columns: 1fr;
            }
            .settings-grid {
                grid-template-columns: 1fr;
            }
            .data-table th, .data-table td {
                padding: 0.6rem 0.5rem;
                font-size: 0.85rem;
            }
            .footer-inner {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .footer-logo {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen">
        <div class="login-card">
            <div class="login-logo">会派予算管理</div>
            <div class="login-sub">創政MISATO 会員専用システム</div>
            <div class="login-error" id="loginError">パスワードが正しくありません</div>
            <input type="password" class="login-input" id="passwordInput" placeholder="パスワードを入力">
            <button class="login-btn" onclick="tryLogin()">ログイン</button>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent">
        <!-- Header -->
        <header class="header">
            <div class="header-inner">
                <a href="/member/" class="header-logo">
                    <div class="header-logo-icon">
                        <img src="../images/logo.png" alt="Logo">
                    </div>
                    <span class="header-logo-text">創政MISATO</span>
                </a>
                <nav class="header-nav">
                    <a href="/member/">会員TOP</a>
                    <a href="/member/search.html">条例検索</a>
                    <a href="/member/budget/" class="active">予算管理</a>
                </nav>
            </div>
        </header>

        <!-- Main -->
        <main class="main-container">
            <div class="page-title">
                <h1>会派予算管理</h1>
                <p id="fiscalYearDisplay">令和7年度（2025年度）</p>
            </div>

            <!-- Account Switcher -->
            <div class="account-switcher">
                <button class="account-btn active seimu" onclick="switchAccount('seimu')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    政務活動費
                </button>
                <button class="account-btn tsumitate" onclick="switchAccount('tsumitate')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
                        <path d="M12 18V6"/>
                    </svg>
                    会派積立金
                </button>
                <button class="account-btn personal" onclick="switchAccount('personal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    個人政活費
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('dashboard')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="7" height="7"/>
                        <rect x="14" y="3" width="7" height="7"/>
                        <rect x="14" y="14" width="7" height="7"/>
                        <rect x="3" y="14" width="7" height="7"/>
                    </svg>
                    概要
                </button>
                <button class="tab-btn" onclick="switchTab('input')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    経費入力
                </button>
                <button class="tab-btn" onclick="switchTab('list')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="8" y1="6" x2="21" y2="6"/>
                        <line x1="8" y1="12" x2="21" y2="12"/>
                        <line x1="8" y1="18" x2="21" y2="18"/>
                        <line x1="3" y1="6" x2="3.01" y2="6"/>
                        <line x1="3" y1="12" x2="3.01" y2="12"/>
                        <line x1="3" y1="18" x2="3.01" y2="18"/>
                    </svg>
                    経費一覧
                </button>
                <button class="tab-btn" onclick="switchTab('settings')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    設定
                </button>
            </div>

            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content active">
                <!-- Stats for Seimu -->
                <div id="seimuStats">
                    <div class="stats-grid">
                        <div class="stat-card total">
                            <div class="stat-label">政務活動費 年間予算</div>
                            <div class="stat-value" id="seimuTotal">¥0</div>
                            <div class="stat-sub">総額</div>
                        </div>
                        <div class="stat-card used">
                            <div class="stat-label">使用済み</div>
                            <div class="stat-value" id="seimuUsed">¥0</div>
                            <div class="stat-sub" id="seimuUsedPercent">0%</div>
                        </div>
                        <div class="stat-card remaining">
                            <div class="stat-label">残り予算</div>
                            <div class="stat-value" id="seimuRemaining">¥0</div>
                            <div class="stat-sub" id="seimuRemainingPercent">100%</div>
                        </div>
                    </div>
                    <div class="progress-section">
                        <div class="progress-header">
                            <span class="progress-title">政務活動費 消化率</span>
                            <span class="progress-percent" id="seimuProgressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="seimuProgressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- Stats for Tsumitate -->
                <div id="tsumitateStats" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-card total tsumitate">
                            <div class="stat-label">会派積立金 累計</div>
                            <div class="stat-value" id="tsumitateTotal">¥0</div>
                            <div class="stat-sub">積立総額</div>
                        </div>
                        <div class="stat-card deposit">
                            <div class="stat-label">今年度積立</div>
                            <div class="stat-value" id="tsumitateDeposit">¥0</div>
                            <div class="stat-sub" id="tsumitateDepositCount">0回</div>
                        </div>
                        <div class="stat-card used">
                            <div class="stat-label">使用済み</div>
                            <div class="stat-value" id="tsumitateUsed">¥0</div>
                            <div class="stat-sub">今年度</div>
                        </div>
                        <div class="stat-card remaining">
                            <div class="stat-label">残高</div>
                            <div class="stat-value" id="tsumitateRemaining">¥0</div>
                            <div class="stat-sub">現在</div>
                        </div>
                    </div>
                    <!-- Deposit Input -->
                    <div class="deposit-section">
                        <div class="deposit-header">
                            <span class="deposit-title">積立金を追加</span>
                        </div>
                        <div class="deposit-form">
                            <input type="date" id="depositDate">
                            <select id="depositDepositor" style="width:120px;">
                                <option value="">メンバー</option>
                                <option value="佐藤裕之">佐藤裕之</option>
                                <option value="高橋誠一">高橋誠一</option>
                                <option value="日髙千穂">日髙千穂</option>
                                <option value="鈴木優作">鈴木優作</option>
                            </select>
                            <input type="number" id="depositAmount" placeholder="金額（例: 10000）" style="width:120px;">
                            <input type="text" id="depositNote" placeholder="メモ（任意）" style="flex:1;min-width:100px;">
                            <button class="btn btn-primary btn-sm" onclick="addDeposit()">追加</button>
                        </div>
                        <!-- Deposit History -->
                        <div id="depositHistory" class="deposit-history" style="margin-top:1rem;max-height:200px;overflow-y:auto;"></div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-title">カテゴリ別内訳</div>
                        <div class="chart-container">
                            <canvas id="categoryChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-title">月別推移</div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Tab -->
            <div id="tab-input" class="tab-content">
                <div class="form-card">
                    <div class="form-title">経費を追加</div>

                    <!-- Receipt Upload -->
                    <div class="receipt-upload-section" id="receiptUpload" onclick="document.getElementById('receiptInput').click()">
                        <input type="file" class="receipt-upload-input" id="receiptInput" accept="image/*" onchange="handleReceiptUpload(event)">
                        <div class="receipt-upload-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                <polyline points="21 15 16 10 5 21"/>
                            </svg>
                        </div>
                        <div class="receipt-upload-text">領収書の写真をアップロード</div>
                        <div class="receipt-upload-sub">AIが自動で日付・金額・摘要を読み取ります</div>
                        <div class="receipt-preview" id="receiptPreview">
                            <img id="receiptImage" src="" alt="領収書">
                        </div>
                        <div class="ai-analyzing" id="aiAnalyzing">
                            <span class="ai-analyzing-spinner"></span>
                            AIが領収書を解析中...
                        </div>
                    </div>

                    <form id="expenseForm" onsubmit="submitExpense(event)">
                        <input type="hidden" id="editExpenseId">

                        <!-- Account Toggle -->
                        <div class="form-group">
                            <label class="form-label">会計区分 *</label>
                            <div class="account-toggle">
                                <button type="button" class="account-toggle-btn active seimu" onclick="setFormAccount('seimu')">政務活動費</button>
                                <button type="button" class="account-toggle-btn tsumitate" onclick="setFormAccount('tsumitate')">会派積立金</button>
                            </div>
                            <input type="hidden" id="expenseAccount" value="seimu">
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label class="form-label">日付 *</label>
                                <input type="date" class="form-input" id="expenseDate" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">カテゴリ *</label>
                                <select class="form-select" id="expenseCategory" required>
                                    <option value="">選択してください</option>
                                    <option value="research">調査研究費</option>
                                    <option value="training">研修費</option>
                                    <option value="pr">広報費</option>
                                    <option value="materials">資料購入費</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">金額 *</label>
                                <input type="number" class="form-input" id="expenseAmount" placeholder="例: 5000" min="1" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">摘要 *</label>
                            <input type="text" class="form-input" id="expenseDescription" placeholder="例: 書籍購入" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">備考</label>
                            <textarea class="form-textarea" id="expenseNote" placeholder="詳細メモ（任意）"></textarea>
                        </div>
                        <div class="form-buttons">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">クリア</button>
                            <button type="submit" class="btn btn-primary" id="submitBtn">保存する</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- List Tab -->
            <div id="tab-list" class="tab-content">
                <div class="table-card">
                    <div class="table-header">
                        <div class="table-title">経費一覧</div>
                        <div class="table-filters">
                            <select class="filter-select" id="filterAccount" onchange="renderExpenseTable()">
                                <option value="">全会計</option>
                                <option value="seimu">政務活動費</option>
                                <option value="tsumitate">会派積立金</option>
                            </select>
                            <select class="filter-select" id="filterCategory" onchange="renderExpenseTable()">
                                <option value="">全カテゴリ</option>
                                <option value="research">調査研究費</option>
                                <option value="training">研修費</option>
                                <option value="pr">広報費</option>
                                <option value="materials">資料購入費</option>
                                <option value="other">その他</option>
                            </select>
                            <select class="filter-select" id="filterMonth" onchange="renderExpenseTable()">
                                <option value="">全期間</option>
                            </select>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>会計</th>
                                    <th>カテゴリ</th>
                                    <th>摘要</th>
                                    <th>金額</th>
                                    <th>領収書</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <div class="table-total">
                            合計: <span id="filteredTotal">¥0</span>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="exportCSV()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            CSV出力
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="tab-settings" class="tab-content">
                <div class="settings-grid">
                    <div class="settings-card">
                        <div class="settings-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                <line x1="16" y1="2" x2="16" y2="6"/>
                                <line x1="8" y1="2" x2="8" y2="6"/>
                                <line x1="3" y1="10" x2="21" y2="10"/>
                            </svg>
                            基本設定
                        </div>
                        <div class="form-group">
                            <label class="form-label">年度</label>
                            <select class="form-select" id="settingYear" onchange="updateFiscalYear()">
                                <option value="2024">令和6年度（2024年度）</option>
                                <option value="2025" selected>令和7年度（2025年度）</option>
                                <option value="2026">令和8年度（2026年度）</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">政務活動費 年間予算（円）</label>
                            <input type="number" class="form-input" id="settingSeimuBudget" placeholder="例: 1200000" min="0">
                        </div>
                        <div class="form-group">
                            <label class="form-label">積立金 初期残高（円）</label>
                            <input type="number" class="form-input" id="settingTsumitateInitial" placeholder="例: 0" min="0">
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="saveBudgetSettings()" style="margin-top:0.5rem;">保存</button>
                    </div>

                    <div class="settings-card" style="border-left:4px solid #6366f1;">
                        <div class="settings-title" style="color:#6366f1;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            個人政務活動費 予算設定
                        </div>
                        <p style="font-size:0.85rem;color:var(--gray);margin-bottom:1rem;">
                            各メンバーの年間予算を設定できます（月額34,000円×12ヶ月=408,000円が基準）
                        </p>
                        <div class="personal-budget-settings">
                            <div class="form-group" style="display:flex;gap:1rem;align-items:center;margin-bottom:0.5rem;">
                                <label style="width:100px;font-weight:500;">佐藤裕之</label>
                                <input type="number" class="form-input" id="personalBudget_佐藤裕之" placeholder="408000" min="0" style="flex:1;">
                                <span style="color:var(--gray);font-size:0.85rem;">円</span>
                            </div>
                            <div class="form-group" style="display:flex;gap:1rem;align-items:center;margin-bottom:0.5rem;">
                                <label style="width:100px;font-weight:500;">高橋誠一</label>
                                <input type="number" class="form-input" id="personalBudget_高橋誠一" placeholder="408000" min="0" style="flex:1;">
                                <span style="color:var(--gray);font-size:0.85rem;">円</span>
                            </div>
                            <div class="form-group" style="display:flex;gap:1rem;align-items:center;margin-bottom:0.5rem;">
                                <label style="width:100px;font-weight:500;">日髙千穂</label>
                                <input type="number" class="form-input" id="personalBudget_日髙千穂" placeholder="408000" min="0" style="flex:1;">
                                <span style="color:var(--gray);font-size:0.85rem;">円</span>
                            </div>
                            <div class="form-group" style="display:flex;gap:1rem;align-items:center;margin-bottom:0.5rem;">
                                <label style="width:100px;font-weight:500;">鈴木優作</label>
                                <input type="number" class="form-input" id="personalBudget_鈴木優作" placeholder="408000" min="0" style="flex:1;">
                                <span style="color:var(--gray);font-size:0.85rem;">円</span>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick="savePersonalBudgetSettings()" style="margin-top:0.5rem;background:linear-gradient(135deg, #6366f1, #8b5cf6);">個人予算を保存</button>
                    </div>

                    <div class="settings-card">
                        <div class="settings-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="17 8 12 3 7 8"/>
                                <line x1="12" y1="3" x2="12" y2="15"/>
                            </svg>
                            データ管理
                        </div>
                        <p style="font-size:0.9rem;color:var(--gray);margin-bottom:1rem;">
                            データのバックアップと復元ができます。
                        </p>
                        <div class="export-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="exportData()">
                                データ出力
                            </button>
                            <label class="btn btn-secondary btn-sm" style="cursor:pointer;">
                                データ取込
                                <input type="file" accept=".json" onchange="importData(event)" style="display:none;">
                            </label>
                            <button class="btn btn-danger btn-sm" onclick="confirmClearData()">
                                全削除
                            </button>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            使い方
                        </div>
                        <ul style="font-size:0.9rem;color:var(--gray);padding-left:1.2rem;">
                            <li><strong>政務活動費</strong>：議員の政務活動に使える公費</li>
                            <li><strong>会派積立金</strong>：メンバーが毎月積み立てる自己資金</li>
                            <li>政務活動費として計上できない経費は積立金から支出</li>
                            <li>領収書を撮影するとAIが自動で項目を読み取ります</li>
                        </ul>
                    </div>

                    <div class="settings-card">
                        <div class="settings-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2"/>
                                <circle cx="7" cy="17" r="2"/>
                                <circle cx="17" cy="17" r="2"/>
                            </svg>
                            車両・交通費ルール
                        </div>
                        <div style="font-size:0.9rem;color:var(--gray);">
                            <p style="margin-bottom:0.8rem;font-weight:600;color:var(--text);">基本方針</p>
                            <p style="margin-bottom:1rem;">運転者の負担（ガソリン代・労力）を考慮し、会派積立金または個人負担で精算する。</p>

                            <p style="margin-bottom:0.5rem;font-weight:600;color:var(--text);">近距離（三郷市内など）</p>
                            <ul style="padding-left:1.2rem;margin-bottom:1rem;">
                                <li>1人あたり <strong>1,000円</strong> を運転者に支払う（または積立金から）</li>
                            </ul>

                            <p style="margin-bottom:0.5rem;font-weight:600;color:var(--text);">長距離（羽田空港、高速利用を伴う視察など）</p>
                            <ul style="padding-left:1.2rem;">
                                <li><strong>実費精算</strong>：高速代、駐車場代は実費を積立金から支払う</li>
                                <li><strong>運転・ガソリン代</strong>：1人あたり <strong>2,000円</strong> 程度を運転者に支払う</li>
                            </ul>
                        </div>
                    </div>

                    <div class="settings-card">
                        <div class="settings-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14 2 14 8 20 8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                            </svg>
                            質問通告書のテクニック
                        </div>
                        <div style="font-size:0.9rem;color:var(--gray);">
                            <p style="margin-bottom:0.8rem;">通告書に書く「お題目（大項目）」は、<strong style="color:var(--text);">あえて抽象的・大雑把に書く</strong>。</p>
                            <p style="margin-bottom:0.5rem;font-weight:600;color:var(--text);">理由：</p>
                            <ul style="padding-left:1.2rem;">
                                <li>具体的に書きすぎると、本番で「これについては通告にないので答えられません」と封じられる</li>
                                <li>議論の展開ができなくなるのを防ぐため</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Budget Tab -->
            <div id="tab-personal" class="tab-content">
                <div class="personal-header">
                    <h2 class="section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:24px;height:24px;">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                        個人政務活動費
                    </h2>
                    <div class="member-tabs">
                        <button class="member-tab active" onclick="switchPersonalMemberTab('佐藤裕之')">佐藤裕之</button>
                        <button class="member-tab" onclick="switchPersonalMemberTab('高橋誠一')">高橋誠一</button>
                        <button class="member-tab" onclick="switchPersonalMemberTab('日髙千穂')">日髙千穂</button>
                        <button class="member-tab" onclick="switchPersonalMemberTab('鈴木優作')">鈴木優作</button>
                    </div>
                    <!-- Hidden select for form compatibility -->
                    <select id="personalMember" style="display:none;">
                        <option value="佐藤裕之">佐藤裕之</option>
                        <option value="高橋誠一">高橋誠一</option>
                        <option value="日髙千穂">日髙千穂</option>
                        <option value="鈴木優作">鈴木優作</option>
                    </select>
                </div>

                <!-- Personal Stats -->
                <div class="stats-grid" style="margin-bottom:1.5rem;">
                    <div class="stat-card total" style="background:linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                        <div class="stat-label">年間予算</div>
                        <div class="stat-value" id="personalTotal">¥408,000</div>
                        <div class="stat-sub">令和7年度</div>
                    </div>
                    <div class="stat-card used">
                        <div class="stat-label">使用済み</div>
                        <div class="stat-value" id="personalUsed">¥0</div>
                        <div class="stat-sub" id="personalUsedPercent">0%</div>
                    </div>
                    <div class="stat-card remaining">
                        <div class="stat-label">残り予算</div>
                        <div class="stat-value" id="personalRemaining">¥408,000</div>
                        <div class="stat-sub" id="personalRemainingPercent">100%</div>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="progress-container" style="margin-bottom:2rem;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="personalProgressFill" style="width:0%;background:linear-gradient(90deg, #6366f1, #8b5cf6);"></div>
                    </div>
                    <div class="progress-text">
                        <span>使用率</span>
                        <span id="personalProgressPercent">0%</span>
                    </div>
                </div>

                <!-- Personal Expense Input -->
                <div class="card" style="margin-bottom:1.5rem;">
                    <div class="card-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;">
                            <path d="M12 5v14M5 12h14"/>
                        </svg>
                        経費を追加
                    </div>
                    <form id="personalExpenseForm" onsubmit="submitPersonalExpense(event)">
                        <div class="form-row">
                            <div class="form-group" style="flex:1;">
                                <label class="form-label">日付</label>
                                <input type="date" class="form-input" id="personalExpenseDate" required>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label class="form-label">カテゴリ</label>
                                <select class="form-select" id="personalExpenseCategory" required>
                                    <option value="research">調査研究費</option>
                                    <option value="training">研修費</option>
                                    <option value="pr">広報費</option>
                                    <option value="materials">資料購入費</option>
                                    <option value="other">その他</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label class="form-label">金額</label>
                                <input type="number" class="form-input" id="personalExpenseAmount" placeholder="例: 5000" min="1" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group" style="flex:2;">
                                <label class="form-label">摘要</label>
                                <input type="text" class="form-input" id="personalExpenseDescription" placeholder="例: 書籍購入" required>
                            </div>
                            <div class="form-group" style="flex:1;">
                                <label class="form-label">備考</label>
                                <input type="text" class="form-input" id="personalExpenseNote" placeholder="任意">
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" style="background:linear-gradient(135deg, #6366f1, #8b5cf6);">追加</button>
                    </form>
                </div>

                <!-- Personal Expense Table -->
                <div class="card">
                    <div class="card-header">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px;height:20px;">
                            <line x1="8" y1="6" x2="21" y2="6"/>
                            <line x1="8" y1="12" x2="21" y2="12"/>
                            <line x1="8" y1="18" x2="21" y2="18"/>
                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                        </svg>
                        経費一覧
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>日付</th>
                                    <th>カテゴリ</th>
                                    <th>摘要</th>
                                    <th>金額</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="personalExpenseTableBody">
                            </tbody>
                        </table>
                    </div>
                    <div class="table-footer">
                        <span>合計: <strong id="personalFilteredTotal">¥0</strong></span>
                        <button class="btn btn-secondary btn-sm" onclick="exportPersonalCSV()">CSV出力</button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <div class="footer-inner">
                <div class="footer-brand">
                    <div class="footer-logo">
                        <img src="../images/logo.png" alt="創政MISATO">
                        <span class="footer-logo-text">創政MISATO</span>
                    </div>
                    <p class="footer-tagline">三郷市議会 会派<br>市民とともに創る、新しい政治のかたち</p>
                </div>
                <div class="footer-nav-group">
                    <div class="footer-nav-title">会員メニュー</div>
                    <a href="/member/">会員TOP</a>
                    <a href="/member/search.html">条例・法律検索</a>
                    <a href="/member/budget/">予算管理</a>
                </div>
                <div class="footer-nav-group">
                    <div class="footer-nav-title">外部リンク</div>
                    <a href="https://souseimisato.com" target="_blank">公式サイト</a>
                    <a href="https://www.city.misato.lg.jp/shiseijoho/shigikai/" target="_blank" rel="noopener">三郷市議会</a>
                    <a href="https://www1.g-reiki.net/misato/reiki_menu.html" target="_blank" rel="noopener">三郷市例規集</a>
                </div>
            </div>
            <p class="footer-copy">&copy; 2026 創政MISATO - 三郷市議会 会派</p>
        </footer>
    </div>

    <!-- Edit Modal -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">経費を編集</div>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form onsubmit="updateExpenseModal(event)">
                <input type="hidden" id="modalExpenseId">
                <div class="form-group">
                    <label class="form-label">会計区分</label>
                    <select class="form-select" id="modalAccount" required>
                        <option value="seimu">政務活動費</option>
                        <option value="tsumitate">会派積立金</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">日付</label>
                    <input type="date" class="form-input" id="modalDate" required>
                </div>
                <div class="form-group">
                    <label class="form-label">カテゴリ</label>
                    <select class="form-select" id="modalCategory" required>
                        <option value="research">調査研究費</option>
                        <option value="training">研修費</option>
                        <option value="pr">広報費</option>
                        <option value="materials">資料購入費</option>
                        <option value="other">その他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">金額</label>
                    <input type="number" class="form-input" id="modalAmount" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">摘要</label>
                    <input type="text" class="form-input" id="modalDescription" required>
                </div>
                <div class="form-group">
                    <label class="form-label">備考</label>
                    <textarea class="form-textarea" id="modalNote"></textarea>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
                    <button type="submit" class="btn btn-primary">更新する</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script>
        // ===== Supabase Setup =====
        const SUPABASE_URL = 'https://rfbhmdsonengrgumpacx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJmYmhtZHNvbmVuZ3JndW1wYWN4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAyMzAyOTEsImV4cCI6MjA4NTgwNjI5MX0.Z0rE8CYxHSEyz-A0eXx2r7Zgg87hqkLqrl6KEfG01jk';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ===== Constants =====
        const GEMINI_API_URL = 'https://misato-jorei-ai.yusaku-suzuki.workers.dev';

        const DEFAULT_CATEGORIES = [
            { id: 'research', name: '調査研究費' },
            { id: 'training', name: '研修費' },
            { id: 'pr', name: '広報費' },
            { id: 'materials', name: '資料購入費' },
            { id: 'other', name: 'その他' }
        ];

        const CATEGORY_COLORS = {
            research: '#3b82f6',
            training: '#22c55e',
            pr: '#f59e0b',
            materials: '#a855f7',
            other: '#6b7280'
        };

        // ===== State =====
        let budgetConfig = {
            fiscalYear: 2025,
            seimuBudget: 1200000,
            tsumitateInitial: 0
        };

        let expenses = [];
        let deposits = [];
        let currentAccount = 'seimu';
        let categoryChart = null;
        let monthlyChart = null;
        let currentReceiptImageData = null; // Store current receipt image for upload

        // Personal budget state
        let personalBudgetConfig = {};
        let personalExpenses = [];
        let currentPersonalMember = '佐藤裕之';

        // ===== Authentication =====
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function tryLogin() {
            const password = document.getElementById('passwordInput').value;
            const hash = await hashPassword(password);
            const HASH = 'abd4404fff7d3165f63f43321f571867d4dc635047b4f398282d4d42908c3f6b';

            if (hash === HASH) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                sessionStorage.setItem('member_auth', '1');
                initApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') tryLogin();
        });

        // ===== Initialization =====
        async function initApp() {
            await loadData();
            await loadPersonalData();
            renderDashboard();
            renderExpenseTable();
            renderSettings();
            setDefaultDate();
            populateMonthFilter();
            setupDragDrop();
            setPersonalDefaultDate();
            renderPersonalDashboard();
            renderPersonalExpenseTable();
        }

        async function loadData() {
            try {
                // Load budget config
                const { data: configData, error: configError } = await supabaseClient
                    .from('budget_config')
                    .select('*')
                    .order('id', { ascending: false })
                    .limit(1)
                    .single();

                if (configData && !configError) {
                    budgetConfig = {
                        fiscalYear: configData.fiscal_year,
                        seimuBudget: configData.seimu_budget,
                        tsumitateInitial: configData.tsumitate_budget
                    };
                }

                // Load expenses
                const { data: expensesData, error: expensesError } = await supabaseClient
                    .from('expenses')
                    .select('*')
                    .order('date', { ascending: false });

                if (expensesData && !expensesError) {
                    expenses = expensesData.map(e => ({
                        id: e.id,
                        date: e.date,
                        category: e.category,
                        amount: e.amount,
                        description: e.description || '',
                        note: e.note || '',
                        account: e.account_type || 'seimu',
                        receiptImageUrl: e.receipt_image_url || null,
                        createdAt: e.created_at
                    }));
                }

                // Load deposits
                const { data: depositsData, error: depositsError } = await supabaseClient
                    .from('deposits')
                    .select('*')
                    .order('date', { ascending: false });

                if (depositsData && !depositsError) {
                    deposits = depositsData.map(d => ({
                        id: d.id,
                        date: d.date,
                        depositor: d.depositor || '',
                        amount: d.amount,
                        note: d.note || '',
                        createdAt: d.created_at
                    }));
                }

                updateFiscalYearDisplay();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('データの読み込みに失敗しました', 'error');
            }
        }

        async function saveConfig() {
            try {
                const { error } = await supabaseClient
                    .from('budget_config')
                    .upsert({
                        id: 1,
                        fiscal_year: budgetConfig.fiscalYear,
                        seimu_budget: budgetConfig.seimuBudget,
                        tsumitate_budget: budgetConfig.tsumitateInitial,
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;
            } catch (error) {
                console.error('Error saving config:', error);
                showToast('設定の保存に失敗しました', 'error');
            }
        }

        async function saveExpense(expense) {
            try {
                const { data, error } = await supabaseClient
                    .from('expenses')
                    .insert({
                        date: expense.date,
                        category: expense.category,
                        amount: expense.amount,
                        description: expense.description,
                        note: expense.note,
                        account_type: expense.account
                    })
                    .select()
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error saving expense:', error);
                showToast('経費の保存に失敗しました', 'error');
                return null;
            }
        }

        async function updateExpense(expense) {
            try {
                const { error } = await supabaseClient
                    .from('expenses')
                    .update({
                        date: expense.date,
                        category: expense.category,
                        amount: expense.amount,
                        description: expense.description,
                        note: expense.note,
                        account_type: expense.account
                    })
                    .eq('id', expense.id);

                if (error) throw error;
            } catch (error) {
                console.error('Error updating expense:', error);
                showToast('経費の更新に失敗しました', 'error');
            }
        }

        async function deleteExpenseFromDB(id) {
            try {
                const { error } = await supabaseClient
                    .from('expenses')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
            } catch (error) {
                console.error('Error deleting expense:', error);
                showToast('経費の削除に失敗しました', 'error');
            }
        }

        async function saveDeposit(deposit) {
            try {
                const { data, error } = await supabaseClient
                    .from('deposits')
                    .insert({
                        date: deposit.date,
                        depositor: deposit.depositor,
                        amount: deposit.amount,
                        note: deposit.note
                    })
                    .select()
                    .single();

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error saving deposit:', error);
                showToast('積立金の保存に失敗しました', 'error');
                return null;
            }
        }

        // Legacy functions for compatibility
        function saveExpenses() {
            // Now handled by individual save functions
        }

        function saveDeposits() {
            // Now handled by individual save functions
        }

        // ===== Account Switching =====
        function switchAccount(account) {
            currentAccount = account;

            document.querySelectorAll('.account-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.currentTarget.classList.add('active');

            // Show/hide tab navigation based on account
            const tabNav = document.querySelector('.tab-nav');
            const personalTab = document.getElementById('tab-personal');

            if (account === 'personal') {
                // 個人政活費の場合：タブナビを非表示にし、個人タブのみ表示
                tabNav.style.display = 'none';
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                personalTab.classList.add('active');
                loadPersonalData();
            } else {
                // 政務活動費・積立金の場合：通常のタブ表示
                tabNav.style.display = 'flex';
                document.getElementById('seimuStats').style.display = account === 'seimu' ? 'block' : 'none';
                document.getElementById('tsumitateStats').style.display = account === 'tsumitate' ? 'block' : 'none';

                // Update form account toggle
                setFormAccount(account);

                // Update filter
                document.getElementById('filterAccount').value = account;

                // 個人タブが表示されていたら概要タブに戻す
                if (personalTab.classList.contains('active')) {
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById('tab-dashboard').classList.add('active');
                    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.tab-btn').classList.add('active');
                }

                renderDashboard();
                renderExpenseTable();
            }
        }

        function setFormAccount(account) {
            document.getElementById('expenseAccount').value = account;
            document.querySelectorAll('.account-toggle-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.account-toggle-btn.${account}`).classList.add('active');
        }

        // ===== Tab Switching =====
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.currentTarget.classList.add('active');
            document.getElementById('tab-' + tabId).classList.add('active');

            if (tabId === 'dashboard') {
                renderDashboard();
            }
        }

        // ===== Dashboard =====
        function renderDashboard() {
            // Seimu stats
            const seimuExpenses = expenses.filter(e => e.account === 'seimu');
            const seimuUsed = seimuExpenses.reduce((sum, e) => sum + e.amount, 0);
            const seimuRemaining = budgetConfig.seimuBudget - seimuUsed;
            const seimuPercent = budgetConfig.seimuBudget > 0 ? (seimuUsed / budgetConfig.seimuBudget * 100) : 0;

            document.getElementById('seimuTotal').textContent = formatCurrency(budgetConfig.seimuBudget);
            document.getElementById('seimuUsed').textContent = formatCurrency(seimuUsed);
            document.getElementById('seimuUsedPercent').textContent = seimuPercent.toFixed(1) + '%';
            document.getElementById('seimuRemaining').textContent = formatCurrency(seimuRemaining);
            document.getElementById('seimuRemainingPercent').textContent = (100 - seimuPercent).toFixed(1) + '%';
            document.getElementById('seimuProgressPercent').textContent = seimuPercent.toFixed(1) + '%';

            const seimuFill = document.getElementById('seimuProgressFill');
            seimuFill.style.width = Math.min(seimuPercent, 100) + '%';
            seimuFill.className = 'progress-fill' + (seimuPercent > 90 ? ' danger' : seimuPercent > 70 ? ' warning' : '');

            // Tsumitate stats
            const tsumitateDeposits = deposits.reduce((sum, d) => sum + d.amount, 0);
            const tsumitateExpenses = expenses.filter(e => e.account === 'tsumitate');
            const tsumitateUsed = tsumitateExpenses.reduce((sum, e) => sum + e.amount, 0);
            const tsumitateTotal = budgetConfig.tsumitateInitial + tsumitateDeposits;
            const tsumitateRemaining = tsumitateTotal - tsumitateUsed;

            document.getElementById('tsumitateTotal').textContent = formatCurrency(tsumitateTotal);
            document.getElementById('tsumitateDeposit').textContent = formatCurrency(tsumitateDeposits);
            document.getElementById('tsumitateDepositCount').textContent = deposits.length + '回';
            document.getElementById('tsumitateUsed').textContent = formatCurrency(tsumitateUsed);
            document.getElementById('tsumitateRemaining').textContent = formatCurrency(tsumitateRemaining);

            // Set deposit date default
            document.getElementById('depositDate').value = new Date().toISOString().split('T')[0];

            renderDepositHistory();
            renderCategoryChart();
            renderMonthlyChart();
        }

        async function addDeposit() {
            const date = document.getElementById('depositDate').value;
            const depositor = document.getElementById('depositDepositor').value;
            const amount = parseInt(document.getElementById('depositAmount').value);
            const note = document.getElementById('depositNote').value;

            if (!date || !depositor || !amount || amount <= 0) {
                showToast('日付、入金者、金額を入力してください', 'error');
                return;
            }

            const deposit = { date, depositor, amount, note };
            const saved = await saveDeposit(deposit);

            if (saved) {
                deposits.unshift({
                    id: saved.id,
                    date: saved.date,
                    depositor: saved.depositor || '',
                    amount: saved.amount,
                    note: saved.note || '',
                    createdAt: saved.created_at
                });

                document.getElementById('depositAmount').value = '';
                document.getElementById('depositNote').value = '';
                document.getElementById('depositDepositor').value = '';
                renderDashboard();
                showToast('積立金を追加しました', 'success');
            }
        }

        function renderDepositHistory() {
            const container = document.getElementById('depositHistory');
            if (deposits.length === 0) {
                container.innerHTML = '<p style="color:var(--gray);font-size:0.85rem;text-align:center;padding:1rem;">入金履歴はありません</p>';
                return;
            }

            container.innerHTML = `
                <table style="width:100%;font-size:0.8rem;border-collapse:collapse;">
                    <thead>
                        <tr style="background:var(--gray-lighter);">
                            <th style="padding:0.4rem;text-align:left;">日付</th>
                            <th style="padding:0.4rem;text-align:left;">入金者</th>
                            <th style="padding:0.4rem;text-align:right;">金額</th>
                            <th style="padding:0.4rem;text-align:left;">メモ</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${deposits.map(d => `
                            <tr style="border-bottom:1px solid var(--gray-light);">
                                <td style="padding:0.4rem;">${formatDate(d.date)}</td>
                                <td style="padding:0.4rem;">${escapeHtml(d.depositor || '-')}</td>
                                <td style="padding:0.4rem;text-align:right;">${formatCurrency(d.amount)}</td>
                                <td style="padding:0.4rem;color:var(--gray);">${escapeHtml(d.note || '')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const filteredExpenses = currentAccount ? expenses.filter(e => e.account === currentAccount) : expenses;

            const categoryTotals = {};
            DEFAULT_CATEGORIES.forEach(cat => {
                categoryTotals[cat.id] = 0;
            });

            filteredExpenses.forEach(exp => {
                if (categoryTotals[exp.category] !== undefined) {
                    categoryTotals[exp.category] += exp.amount;
                }
            });

            const labels = DEFAULT_CATEGORIES.map(cat => cat.name);
            const data = DEFAULT_CATEGORIES.map(cat => categoryTotals[cat.id]);
            const colors = DEFAULT_CATEGORIES.map(cat => CATEGORY_COLORS[cat.id] || '#6b7280');

            if (categoryChart) {
                categoryChart.destroy();
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                padding: 15,
                                font: {
                                    family: "'Noto Sans JP', sans-serif"
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyChart() {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            const filteredExpenses = currentAccount ? expenses.filter(e => e.account === currentAccount) : expenses;

            const monthlyTotals = {};
            const year = budgetConfig.fiscalYear;

            for (let m = 4; m <= 12; m++) {
                monthlyTotals[`${year}-${String(m).padStart(2, '0')}`] = 0;
            }
            for (let m = 1; m <= 3; m++) {
                monthlyTotals[`${year + 1}-${String(m).padStart(2, '0')}`] = 0;
            }

            filteredExpenses.forEach(exp => {
                const month = exp.date.substring(0, 7);
                if (monthlyTotals[month] !== undefined) {
                    monthlyTotals[month] += exp.amount;
                }
            });

            const labels = Object.keys(monthlyTotals).map(m => {
                const [y, mo] = m.split('-');
                return `${parseInt(mo)}月`;
            });
            const data = Object.values(monthlyTotals);

            if (monthlyChart) {
                monthlyChart.destroy();
            }

            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '支出額',
                        data: data,
                        backgroundColor: currentAccount === 'tsumitate' ? '#f59e0b' : '#0d9488',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => '¥' + value.toLocaleString()
                            }
                        }
                    }
                }
            });
        }

        // ===== Receipt Upload & AI =====
        function setupDragDrop() {
            const dropZone = document.getElementById('receiptUpload');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'), false);
            });

            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            }, false);
        }

        function handleReceiptUpload(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showToast('画像ファイルを選択してください', 'error');
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = async (e) => {
                currentReceiptImageData = e.target.result; // Store for later upload
                document.getElementById('receiptImage').src = e.target.result;
                document.getElementById('receiptPreview').classList.add('show');
                document.getElementById('aiAnalyzing').classList.add('show');

                // Send to AI for analysis
                await analyzeReceipt(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        // Upload receipt image to Supabase Storage
        async function uploadReceiptImage(expenseId) {
            if (!currentReceiptImageData) return null;

            try {
                // Convert base64 to blob
                const base64Data = currentReceiptImageData.split(',')[1];
                const mimeType = currentReceiptImageData.match(/data:([^;]+);/)[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: mimeType });

                // Generate unique filename
                const ext = mimeType.split('/')[1] || 'jpg';
                const fileName = `${expenseId}.${ext}`;

                // Upload to Supabase Storage
                const { data, error } = await supabaseClient
                    .storage
                    .from('receipts')
                    .upload(fileName, blob, {
                        contentType: mimeType,
                        upsert: true
                    });

                if (error) throw error;

                // Get public URL
                const { data: urlData } = supabaseClient
                    .storage
                    .from('receipts')
                    .getPublicUrl(fileName);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading receipt image:', error);
                return null;
            }
        }

        async function analyzeReceipt(imageData) {
            try {
                showToast('画像を認識中...', 'info');

                const response = await fetch(GEMINI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: '領収書画像を解析',
                        receiptImage: imageData,
                        isReceiptAnalysis: true
                    })
                });

                const result = await response.json();

                // Check for error response from API
                if (result.error) {
                    // エラーメッセージをより分かりやすく表示
                    let errorMessage = result.error;
                    if (result.error.includes('レシート/領収書ではない')) {
                        errorMessage = 'この画像はレシート/領収書として認識できませんでした。別の画像をお試しください。';
                    }
                    showToast(errorMessage, 'error');
                    return;
                }

                if (!response.ok) {
                    throw new Error('AI解析に失敗しました');
                }

                if (result.receiptData) {
                    // 認識成功のログ
                    if (result.recognition) {
                        console.log('Receipt recognized with confidence:', result.recognition.confidence);
                    }

                    let filledFields = [];
                    let missingFields = [];

                    // Fill form with AI results, tracking what was filled
                    if (result.receiptData.date) {
                        document.getElementById('expenseDate').value = result.receiptData.date;
                        filledFields.push('日付');
                    } else {
                        missingFields.push('日付');
                    }

                    if (result.receiptData.amount && result.receiptData.amount > 0) {
                        document.getElementById('expenseAmount').value = result.receiptData.amount;
                        filledFields.push('金額');
                    } else {
                        missingFields.push('金額');
                    }

                    if (result.receiptData.description) {
                        document.getElementById('expenseDescription').value = result.receiptData.description;
                        filledFields.push('摘要');
                    }

                    if (result.receiptData.category) {
                        document.getElementById('expenseCategory').value = result.receiptData.category;
                        filledFields.push('カテゴリ');
                    }

                    if (result.receiptData.note) {
                        document.getElementById('expenseNote').value = result.receiptData.note;
                    }

                    // Suggest account type
                    if (result.receiptData.suggestedAccount) {
                        setFormAccount(result.receiptData.suggestedAccount);
                    }

                    // Show appropriate message with confidence
                    const confidenceText = result.recognition?.confidence >= 0.9 ? '' : '（認識精度が低い可能性があります）';
                    if (missingFields.length > 0) {
                        showToast(`読み取り完了${confidenceText}。${missingFields.join('、')}は手動入力してください`, 'warning');
                    } else {
                        showToast(`領収書を読み取りました${confidenceText}。内容を確認してください`, 'success');
                    }
                } else {
                    showToast('領収書の読み取りに失敗しました。画像が鮮明であることを確認してください', 'error');
                }
            } catch (error) {
                console.error('Receipt analysis error:', error);
                showToast('AI解析エラー: ' + error.message, 'error');
            } finally {
                document.getElementById('aiAnalyzing').classList.remove('show');
            }
        }

        // ===== Expense Form =====
        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expenseDate').value = today;
        }

        function resetForm() {
            document.getElementById('expenseForm').reset();
            document.getElementById('editExpenseId').value = '';
            document.getElementById('submitBtn').textContent = '保存する';
            document.getElementById('receiptPreview').classList.remove('show');
            document.getElementById('receiptInput').value = '';
            setDefaultDate();
            setFormAccount(currentAccount);
        }

        async function submitExpense(event) {
            event.preventDefault();

            const editId = document.getElementById('editExpenseId').value;
            const expense = {
                id: editId || null,
                account: document.getElementById('expenseAccount').value,
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseCategory').value,
                amount: parseInt(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value,
                note: document.getElementById('expenseNote').value
            };

            if (editId) {
                await updateExpense(expense);
                const index = expenses.findIndex(e => e.id === editId);
                if (index !== -1) {
                    expenses[index] = { ...expenses[index], ...expense };
                }
                showToast('経費を更新しました', 'success');
            } else {
                const saved = await saveExpense(expense);
                if (saved) {
                    // Upload receipt image if exists
                    let receiptImageUrl = null;
                    if (currentReceiptImageData) {
                        receiptImageUrl = await uploadReceiptImage(saved.id);
                        if (receiptImageUrl) {
                            // Update expense with image URL
                            await supabaseClient
                                .from('expenses')
                                .update({ receipt_image_url: receiptImageUrl })
                                .eq('id', saved.id);
                        }
                    }

                    expenses.unshift({
                        id: saved.id,
                        date: saved.date,
                        category: saved.category,
                        amount: saved.amount,
                        description: saved.description || '',
                        note: saved.note || '',
                        account: saved.account_type || 'seimu',
                        receiptImageUrl: receiptImageUrl,
                        createdAt: saved.created_at
                    });
                    showToast('経費を追加しました', 'success');
                }
            }

            currentReceiptImageData = null; // Clear after saving
            resetForm();
            renderExpenseTable();
            renderDashboard();
        }

        // ===== Expense Table =====
        function populateMonthFilter() {
            const select = document.getElementById('filterMonth');
            const year = budgetConfig.fiscalYear;

            let html = '<option value="">全期間</option>';
            for (let m = 4; m <= 12; m++) {
                html += `<option value="${year}-${String(m).padStart(2, '0')}">${m}月</option>`;
            }
            for (let m = 1; m <= 3; m++) {
                html += `<option value="${year + 1}-${String(m).padStart(2, '0')}">${m}月</option>`;
            }
            select.innerHTML = html;
        }

        function renderExpenseTable() {
            const filterAccount = document.getElementById('filterAccount').value;
            const filterCategory = document.getElementById('filterCategory').value;
            const filterMonth = document.getElementById('filterMonth').value;

            let filtered = expenses.filter(exp => {
                if (filterAccount && exp.account !== filterAccount) return false;
                if (filterCategory && exp.category !== filterCategory) return false;
                if (filterMonth && !exp.date.startsWith(filterMonth)) return false;
                return true;
            });

            filtered.sort((a, b) => b.date.localeCompare(a.date));

            const tbody = document.getElementById('expenseTableBody');

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="no-data">経費データがありません</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(exp => `
                    <tr>
                        <td>${formatDate(exp.date)}</td>
                        <td><span class="account-badge ${exp.account}">${exp.account === 'seimu' ? '政活費' : '積立金'}</span></td>
                        <td><span class="category-badge ${exp.category}">${getCategoryName(exp.category)}</span></td>
                        <td>${escapeHtml(exp.description)}${exp.note ? `<br><small style="color:var(--gray)">${escapeHtml(exp.note)}</small>` : ''}</td>
                        <td class="amount">${formatCurrency(exp.amount)}</td>
                        <td class="receipt-cell">
                            ${exp.receiptImageUrl ? `<a href="${exp.receiptImageUrl}" target="_blank" title="領収書を表示"><img src="${exp.receiptImageUrl}" class="receipt-thumb" alt="領収書"></a>` : '<span style="color:var(--gray);font-size:0.75rem;">-</span>'}
                        </td>
                        <td class="actions">
                            <button onclick="openEditModal('${exp.id}')" title="編集">✏️</button>
                            <button class="delete" onclick="deleteExpense('${exp.id}')" title="削除">🗑️</button>
                        </td>
                    </tr>
                `).join('');
            }

            const total = filtered.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('filteredTotal').textContent = formatCurrency(total);
        }

        async function deleteExpense(id) {
            if (!confirm('この経費を削除しますか？')) return;

            await deleteExpenseFromDB(id);
            expenses = expenses.filter(exp => exp.id !== id);
            renderExpenseTable();
            renderDashboard();
            showToast('経費を削除しました');
        }

        // ===== Edit Modal =====
        function openEditModal(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            document.getElementById('modalExpenseId').value = expense.id;
            document.getElementById('modalAccount').value = expense.account || 'seimu';
            document.getElementById('modalDate').value = expense.date;
            document.getElementById('modalCategory').value = expense.category;
            document.getElementById('modalAmount').value = expense.amount;
            document.getElementById('modalDescription').value = expense.description;
            document.getElementById('modalNote').value = expense.note || '';

            document.getElementById('editModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        async function updateExpenseModal(event) {
            event.preventDefault();

            const id = document.getElementById('modalExpenseId').value;
            const index = expenses.findIndex(exp => exp.id === id);
            if (index === -1) return;

            const updatedExpense = {
                id: id,
                account: document.getElementById('modalAccount').value,
                date: document.getElementById('modalDate').value,
                category: document.getElementById('modalCategory').value,
                amount: parseInt(document.getElementById('modalAmount').value),
                description: document.getElementById('modalDescription').value,
                note: document.getElementById('modalNote').value
            };

            await updateExpense(updatedExpense);

            expenses[index] = {
                ...expenses[index],
                ...updatedExpense
            };

            closeEditModal();
            renderExpenseTable();
            renderDashboard();
            showToast('経費を更新しました', 'success');
        }

        // ===== Settings =====
        function renderSettings() {
            document.getElementById('settingYear').value = budgetConfig.fiscalYear;
            document.getElementById('settingSeimuBudget').value = budgetConfig.seimuBudget;
            document.getElementById('settingTsumitateInitial').value = budgetConfig.tsumitateInitial || 0;

            // Render personal budget settings
            const members = ['佐藤裕之', '高橋誠一', '日髙千穂', '鈴木優作'];
            members.forEach(member => {
                const input = document.getElementById(`personalBudget_${member}`);
                if (input) {
                    input.value = personalBudgetConfig[member] || 408000;
                }
            });
        }

        async function updateFiscalYear() {
            const year = parseInt(document.getElementById('settingYear').value);
            budgetConfig.fiscalYear = year;
            await saveConfig();
            updateFiscalYearDisplay();
            populateMonthFilter();
            renderDashboard();
        }

        function updateFiscalYearDisplay() {
            const year = budgetConfig.fiscalYear;
            const reiwa = year - 2018;
            document.getElementById('fiscalYearDisplay').textContent = `令和${reiwa}年度（${year}年度）`;
        }

        async function saveBudgetSettings() {
            budgetConfig.seimuBudget = parseInt(document.getElementById('settingSeimuBudget').value) || 0;
            budgetConfig.tsumitateInitial = parseInt(document.getElementById('settingTsumitateInitial').value) || 0;
            await saveConfig();
            renderDashboard();
            showToast('設定を保存しました', 'success');
        }

        async function savePersonalBudgetSettings() {
            const members = ['佐藤裕之', '高橋誠一', '日髙千穂', '鈴木優作'];

            try {
                for (const member of members) {
                    const input = document.getElementById(`personalBudget_${member}`);
                    const budget = parseInt(input.value) || 408000;

                    // Update local state
                    personalBudgetConfig[member] = budget;

                    // Upsert to Supabase
                    const { error } = await supabaseClient
                        .from('personal_budget_config')
                        .upsert({
                            member_name: member,
                            fiscal_year: budgetConfig.fiscalYear,
                            budget: budget,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'member_name,fiscal_year'
                        });

                    if (error) {
                        // If upsert fails, try update then insert
                        const { data: existing } = await supabaseClient
                            .from('personal_budget_config')
                            .select('id')
                            .eq('member_name', member)
                            .eq('fiscal_year', budgetConfig.fiscalYear)
                            .single();

                        if (existing) {
                            await supabaseClient
                                .from('personal_budget_config')
                                .update({ budget: budget, updated_at: new Date().toISOString() })
                                .eq('id', existing.id);
                        } else {
                            await supabaseClient
                                .from('personal_budget_config')
                                .insert({
                                    member_name: member,
                                    fiscal_year: budgetConfig.fiscalYear,
                                    budget: budget
                                });
                        }
                    }
                }

                renderPersonalDashboard();
                showToast('個人予算を保存しました', 'success');
            } catch (error) {
                console.error('Error saving personal budget:', error);
                showToast('個人予算の保存に失敗しました', 'error');
            }
        }

        // ===== Data Export/Import =====
        function exportCSV() {
            if (expenses.length === 0) {
                showToast('出力するデータがありません', 'error');
                return;
            }

            const headers = ['日付', '会計区分', 'カテゴリ', '摘要', '金額', '備考'];
            const rows = expenses.map(exp => [
                exp.date,
                exp.account === 'seimu' ? '政務活動費' : '会派積立金',
                getCategoryName(exp.category),
                exp.description,
                exp.amount,
                exp.note || ''
            ]);

            let csv = '\uFEFF';
            csv += headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            downloadFile(csv, `経費一覧_${budgetConfig.fiscalYear}.csv`, 'text/csv;charset=utf-8');
            showToast('CSVファイルを出力しました', 'success');
        }

        function exportData() {
            const data = {
                version: 2,
                exportDate: new Date().toISOString(),
                budgetConfig: budgetConfig,
                expenses: expenses,
                deposits: deposits
            };

            downloadFile(JSON.stringify(data, null, 2), `予算データ_${budgetConfig.fiscalYear}.json`, 'application/json');
            showToast('データを出力しました', 'success');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);

                    if (!data.budgetConfig || !data.expenses) {
                        throw new Error('無効なデータ形式です');
                    }

                    if (!confirm('現在のデータを上書きしますか？')) return;

                    budgetConfig = data.budgetConfig;
                    expenses = data.expenses;
                    deposits = data.deposits || [];
                    saveConfig();
                    saveExpenses();
                    saveDeposits();

                    renderDashboard();
                    renderExpenseTable();
                    renderSettings();
                    populateMonthFilter();

                    showToast('データを取り込みました', 'success');
                } catch (err) {
                    showToast('データの取り込みに失敗しました: ' + err.message, 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function confirmClearData() {
            if (!confirm('すべてのデータを削除しますか？この操作は取り消せません。')) return;
            if (!confirm('本当に削除しますか？')) return;

            budgetConfig = {
                fiscalYear: 2025,
                seimuBudget: 1200000,
                tsumitateInitial: 0
            };
            expenses = [];
            deposits = [];

            saveConfig();
            saveExpenses();
            saveDeposits();

            renderDashboard();
            renderExpenseTable();
            renderSettings();

            showToast('データを削除しました');
        }

        // ===== Utilities =====
        function formatCurrency(amount) {
            return '¥' + amount.toLocaleString();
        }

        function formatDate(dateStr) {
            const [y, m, d] = dateStr.split('-');
            return `${parseInt(m)}/${parseInt(d)}`;
        }

        function getCategoryName(categoryId) {
            const cat = DEFAULT_CATEGORIES.find(c => c.id === categoryId);
            return cat ? cat.name : categoryId;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type: type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast' + (type ? ' ' + type : '');
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ===== Personal Budget Functions =====
        async function loadPersonalData() {
            try {
                // Load personal budget config
                const { data: configData, error: configError } = await supabaseClient
                    .from('personal_budget_config')
                    .select('*')
                    .eq('fiscal_year', budgetConfig.fiscalYear);

                if (configData && !configError) {
                    configData.forEach(c => {
                        personalBudgetConfig[c.member_name] = c.budget;
                    });
                }

                // Load personal expenses
                const { data: expensesData, error: expensesError } = await supabaseClient
                    .from('personal_expenses')
                    .select('*')
                    .order('date', { ascending: false });

                if (expensesData && !expensesError) {
                    personalExpenses = expensesData.map(e => ({
                        id: e.id,
                        memberName: e.member_name,
                        date: e.date,
                        category: e.category,
                        amount: e.amount,
                        description: e.description || '',
                        note: e.note || '',
                        receiptImageUrl: e.receipt_image_url || null,
                        createdAt: e.created_at
                    }));
                }
            } catch (error) {
                console.error('Error loading personal data:', error);
            }
        }

        function switchPersonalMember() {
            currentPersonalMember = document.getElementById('personalMember').value;
            renderPersonalDashboard();
            renderPersonalExpenseTable();
        }

        function switchPersonalMemberTab(memberName) {
            currentPersonalMember = memberName;
            document.getElementById('personalMember').value = memberName;

            // Update tab styles
            document.querySelectorAll('.member-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === memberName) {
                    tab.classList.add('active');
                }
            });

            renderPersonalDashboard();
            renderPersonalExpenseTable();
        }

        function setPersonalDefaultDate() {
            document.getElementById('personalExpenseDate').value = new Date().toISOString().split('T')[0];
        }

        function renderPersonalDashboard() {
            const budget = personalBudgetConfig[currentPersonalMember] || 408000;
            const memberExpenses = personalExpenses.filter(e => e.memberName === currentPersonalMember);
            const used = memberExpenses.reduce((sum, e) => sum + e.amount, 0);
            const remaining = budget - used;
            const percent = budget > 0 ? (used / budget * 100) : 0;

            document.getElementById('personalTotal').textContent = formatCurrency(budget);
            document.getElementById('personalUsed').textContent = formatCurrency(used);
            document.getElementById('personalUsedPercent').textContent = percent.toFixed(1) + '%';
            document.getElementById('personalRemaining').textContent = formatCurrency(remaining);
            document.getElementById('personalRemainingPercent').textContent = (100 - percent).toFixed(1) + '%';
            document.getElementById('personalProgressPercent').textContent = percent.toFixed(1) + '%';

            const progressFill = document.getElementById('personalProgressFill');
            progressFill.style.width = Math.min(percent, 100) + '%';
            if (percent > 90) {
                progressFill.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
            } else if (percent > 70) {
                progressFill.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #6366f1, #8b5cf6)';
            }
        }

        function renderPersonalExpenseTable() {
            const memberExpenses = personalExpenses.filter(e => e.memberName === currentPersonalMember);
            const tbody = document.getElementById('personalExpenseTableBody');

            if (memberExpenses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="no-data">経費データがありません</td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = memberExpenses.map(exp => `
                    <tr>
                        <td>${formatDate(exp.date)}</td>
                        <td><span class="category-badge ${exp.category}">${getCategoryName(exp.category)}</span></td>
                        <td>${escapeHtml(exp.description)}${exp.note ? `<br><small style="color:var(--gray)">${escapeHtml(exp.note)}</small>` : ''}</td>
                        <td class="amount">${formatCurrency(exp.amount)}</td>
                        <td class="actions">
                            <button class="delete" onclick="deletePersonalExpense('${exp.id}')" title="削除">🗑️</button>
                        </td>
                    </tr>
                `).join('');
            }

            const total = memberExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('personalFilteredTotal').textContent = formatCurrency(total);
        }

        async function submitPersonalExpense(event) {
            event.preventDefault();

            const expense = {
                memberName: currentPersonalMember,
                date: document.getElementById('personalExpenseDate').value,
                category: document.getElementById('personalExpenseCategory').value,
                amount: parseInt(document.getElementById('personalExpenseAmount').value),
                description: document.getElementById('personalExpenseDescription').value,
                note: document.getElementById('personalExpenseNote').value
            };

            try {
                const { data, error } = await supabaseClient
                    .from('personal_expenses')
                    .insert({
                        member_name: expense.memberName,
                        date: expense.date,
                        category: expense.category,
                        amount: expense.amount,
                        description: expense.description,
                        note: expense.note
                    })
                    .select()
                    .single();

                if (error) throw error;

                personalExpenses.unshift({
                    id: data.id,
                    memberName: data.member_name,
                    date: data.date,
                    category: data.category,
                    amount: data.amount,
                    description: data.description || '',
                    note: data.note || '',
                    createdAt: data.created_at
                });

                document.getElementById('personalExpenseForm').reset();
                setPersonalDefaultDate();
                renderPersonalDashboard();
                renderPersonalExpenseTable();
                showToast('経費を追加しました', 'success');
            } catch (error) {
                console.error('Error saving personal expense:', error);
                showToast('経費の保存に失敗しました', 'error');
            }
        }

        async function deletePersonalExpense(id) {
            if (!confirm('この経費を削除しますか？')) return;

            try {
                const { error } = await supabaseClient
                    .from('personal_expenses')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                personalExpenses = personalExpenses.filter(e => e.id !== id);
                renderPersonalDashboard();
                renderPersonalExpenseTable();
                showToast('経費を削除しました');
            } catch (error) {
                console.error('Error deleting personal expense:', error);
                showToast('経費の削除に失敗しました', 'error');
            }
        }

        function exportPersonalCSV() {
            const memberExpenses = personalExpenses.filter(e => e.memberName === currentPersonalMember);
            if (memberExpenses.length === 0) {
                showToast('出力するデータがありません', 'error');
                return;
            }

            const headers = ['日付', 'カテゴリ', '摘要', '金額', '備考'];
            const rows = memberExpenses.map(exp => [
                exp.date,
                getCategoryName(exp.category),
                exp.description,
                exp.amount,
                exp.note || ''
            ]);

            let csv = '\uFEFF';
            csv += headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            downloadFile(csv, `個人政務活動費_${currentPersonalMember}_${budgetConfig.fiscalYear}.csv`, 'text/csv;charset=utf-8');
            showToast('CSVファイルを出力しました', 'success');
        }

        // ===== Auto Login Check =====
        if (sessionStorage.getItem('member_auth') === '1') {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            initApp();
        }
    </script>
</body>
</html>
